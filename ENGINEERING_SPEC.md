# ENGINEERING_SPEC.md

## ğŸ“˜ Project Overview

**Project Name:** `disco-tools`  
**Description:**  
Reusable Python utilities for the *disco simulation engine* and related data pipelines.  
Provides composable, high-performance building blocks for label selection, scheduling, data transformation, and simulation orchestration.

**Owner:** Michiel Jansen  
**Repository:** [https://github.com/michielmj/disco-tools](https://github.com/michielmj/disco-tools)  
**License:** MIT  
**Programming Language:** Python â‰¥ 3.11  
**Core Dependency Stack:** `numpy`, `pyyaml`

---

## ğŸ§­ Goals and Scope

### Primary Objectives
- Deliver a **lightweight**, **dependency-minimal**, and **well-typed** toolkit.
- Provide common modules for:
  - Metadata qualification ([`label_selector`](docs/label_selector.md))
  - Serialization (coming)
  - Generic utilities (coming)
- Ensure compatibility with PyPI publishing workflows and CI automation.

### Non-Goals
- Heavy C++ or compiled extensions (pure-Python only)
- Web UI or visualization components (kept separate)
- Framework-specific integrations (focus on generic utility layer)

---

## âš™ï¸ Architecture Overview

### Package Layout

```
src/
â””â”€â”€ tools/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ label_selector/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ core.py
    â”‚   â”œâ”€â”€ label.py
    â”‚   â””â”€â”€ rule.py
    â””â”€â”€ _version.py  # auto-generated by setuptools_scm
tests/
â””â”€â”€ label_selector/
    â”œâ”€â”€ test_core.py
    â””â”€â”€ test_label_rule.py
docs/
â””â”€â”€ label_selector.md
```

### Core Module Responsibilities
| Module | Responsibility |
|---------|----------------|
| `core.py` | Predicate compilation, rule normalization, validation |
| `label.py` | `Label` abstraction with operator overloads and functional form |
| `rule.py` | Rule composition, YAML serialization/deserialization |
| `__init__.py` | Public API, helpers (`all_`, `any_`, `not_`, `select`, `qualifies`) |
| `tests/` | Unit + integration tests via `pytest` |
| `docs/` | Developer and user documentation |

---

## ğŸ§© Key Dependencies

| Dependency | Purpose |
|-------------|----------|
| `numpy` | Shared numerical foundation |
| `pyyaml` | YAML I/O for rules |
| `pytest`, `pytest-cov` | Unit testing and coverage |
| `mypy` | Static type checking |
| `twine`, `build` | Packaging and validation |
| `types-pyyaml` | Type hints for YAML |

---

## ğŸ§± Build System

**Backend:** `setuptools.build_meta`  
**Versioning:** `setuptools-scm` using Git tags (`vX.Y.Z` preferred)  
**Wheel Type:** Universal pure-Python (`py3-none-any.whl`)

### Build Commands

```bash
rm -rf dist build *.egg-info
python -m pip install -U pip setuptools wheel build setuptools-scm
python -m build --sdist --wheel
python -m twine check dist/*
```

### Expected Outputs
```
dist/
â”œâ”€â”€ disco_tools-<version>-py3-none-any.whl
â””â”€â”€ disco_tools-<version>.tar.gz
```

---

## ğŸ§ª Testing and Type Checking

### Local Development

```bash
pip install -e .[dev]
pytest -q
mypy src/tools
```

### Test Script

`test_local.sh` creates an isolated venv, rebuilds from source, and runs both `pytest` and `mypy`.

---

## ğŸš€ Release and Publishing

### Tagging
- Use annotated tags:  
  ```bash
  git tag -a v0.1.0 -m "disco-tools 0.1.0"
  git push --tags
  ```

### GitHub Actions Workflow
- Workflow: `.github/workflows/release-publish.yml`
- Triggers:
  - `on: release: types: [published]`
  - `workflow_dispatch` with manual `publish_target` (`none`, `testpypi`, `pypi`)
- Build steps:
  - Full checkout with tags (`fetch-depth: 0`, `fetch-tags: true`)
  - Clean build via `python -m build`
  - `twine check dist/*`
- Publishing:
  - Uses **Trusted Publishing (OIDC)** with:
    ```yaml
    permissions:
      contents: read
      id-token: write
    uses: pypa/gh-action-pypi-publish@release/v1
    ```
  - Outputs: uploaded to PyPI or TestPyPI based on trigger.

---

## ğŸ”’ Security and Compliance

- **License:** MIT (fully permissive)
- **No embedded secrets:** publishing uses GitHub OIDC (no API token stored)
- **Dependency provenance:** pinned via `pyproject.toml`
- **Code scanning:** compatible with GitHub CodeQL and Mypy type analysis

---

## ğŸ§  Development Guidelines

### Coding Standards
- Use [PEP 8](https://peps.python.org/pep-0008/) style and `black` formatter.
- Explicit typing everywhere (`from __future__ import annotations` where needed).
- Maintain high coverage (> 95 %) on core modules.

### Branching Model
- `main`: stable, publishable.
- `develop`: staging for next release.
- Feature branches: `feature/<module>`.

### Commits and PRs
- Conventional commits (e.g. `feat:`, `fix:`, `docs:`).
- PRs must pass lint, test, type checks before merge.

---

## ğŸ§¾ Metadata

| Field | Value |
|--------|--------|
| **Name** | `disco-tools` |
| **Version Source** | `setuptools-scm` (from Git tag) |
| **Metadata-Version** | 2.4 |
| **Supported Platforms** | `py3-none-any` |
| **License** | MIT |
| **Maintainer** | Michiel Jansen |
| **Homepage** | [GitHub Repository](https://github.com/michielmj/disco-tools) |

---

## ğŸ“š References

- [Label Selector documentation](docs/label_selector.md)
- [PyPI Trusted Publishing Guide](https://docs.pypi.org/trusted-publishers/)
- [PEP 621: Project metadata](https://peps.python.org/pep-0621/)
- [PEP 643 / 566: Core Metadata 2.4+](https://packaging.python.org/en/latest/specifications/core-metadata/)
- [setuptools-scm documentation](https://setuptools-scm.readthedocs.io/en/latest/)
- [PyPI Publish Action](https://github.com/pypa/gh-action-pypi-publish)

---

## âœ… Readiness Checklist

| Category | Status |
|-----------|--------|
| Pure-Python build confirmed | âœ… |
| Wheel metadata validated (`Name`, `Version`, `Metadata-Version`) | âœ… |
| GitHub Actions OIDC publish working | âœ… |
| Manual publish trigger (workflow_dispatch) | âœ… |
| Local test script verified | âœ… |
| Docs link: [`docs/label_selector.md`](docs/label_selector.md) | âœ… |

---

**Last Updated:** 2025-11-06  
**Maintainer:** Michiel Jansen  
**Contact:** via GitHub Issues or [michielmj](https://github.com/michielmj)
